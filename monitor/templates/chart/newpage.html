<!DOCTYPE html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        {% if title %}
            <title>{{ title }} - Monitor</title>
        {% else %}
            <title>Monitor</title>
        {% endif %}
        <!-- loading jQuery UI css -->
        <link rel="stylesheet" type="text/css" href="{{url_for('static',filename='css/jquery-ui.min.css')}}">
        <!-- loading Bootstrap css (required only when you intend to use option.bootstrap) -->
        <link href="{{url_for('static',filename='css/bootstrap.min.css')}}" rel="stylesheet" media="screen"></link>
        <link href="{{url_for('static',filename='css/bootstrap-theme.min.css')}}" rel="stylesheet" ></link>
        <!-- loading font-awesome css (required only when you intend to use the font-awesome iconfont) -->
        <link href="{{url_for('static',filename='css/font-awesome.min.css')}}" rel="stylesheet" media="screen"></link>
        <link href="{{url_for('static',filename='css/jquery.jspanel.min.css')}}" rel="stylesheet" media="screen"></link>
        <link rel="stylesheet" type="text/css" href="{{url_for('static',filename='css/bootstrap-datetimepicker.css')}}">
        <link rel="stylesheet" type="text/css" href="{{url_for('static',filename='css/newpage.css')}}">
        <link rel="stylesheet" type="text/css" href="{{url_for('static',filename='css/dataTables.bootstrap.css')}}">
    </head>
    <body>
        <div class="navbar navbar-default navbar-static-top" role="navigation" style="margin-bottom:0px;">
            <div class="container">
                <div class="navbar-header">
                    <a class="navbar-brand" href="{{ url_for('index') }}">Monitor</a>
                </div>
                <div class="navbar-collapse collapse">
                    <ul class="nav navbar-nav">
                        <li><a href="{{url_for('chart.mainboard')}}">Chart </a></li>
                        {% if g.user.is_admin() %}
                        <li><a href="{{url_for('billing.billing_main')}}">Billing </a></li>
                        <li><a href="{{url_for('auth.config')}}">Auth </a></li>
                        <li><a href="{{url_for('item.mainboard')}}">Item </a></li>
                        {% endif %}
                    </ul>
                    <ul class="nav navbar-nav navbar-right">
                        {% if g.user.is_authenticated() %}
                        <li><a href="{{ url_for('auth.logout') }}">Logout</a></li>
                        {% else %}
                        <li><a href="{{ url_for('auth.login') }}">Login</a></li>
                        {% endif %}
                    </ul>
                </div>
            </div>
        </div>

        <!-- Your HTML goes here -->
        <div class="table-container hidden">
                <table class="table table-bordered page-option">
                    <thead>
                        <th>Save at Server-side</th>
                        <th>Load config saved at Server</th>
                        <th>Delete record in Server</th>
                        <th>Export to Local</th>
                        <th>Load from Local File</th>
                        <th>Clear All 9 Charts</th>
                    </thead>
                    <tbody>
                        <tr>
                            <td>
                                <div class="form-inline">
                                    <div class="form-group">
                                        <input type="text" class="form-control" id="savetext" placeholder="Saved Name">
                                    </div>
                                    <button class="btn btn-primary saveButton">Save</button>
                                </div>
                            </td>
                            <td>
                                <div class="form-inline">
                                    <div class="form-group">
                                        <select class="form-control select-for-load">
                                            <option value="-1" > Select a config</option>
                                            {% for p in pages %}
                                                <option value="{{p.pageid}}" name="{{p.pagename}}">{{p.pagename}}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                
                            </td>
                            <td>
                                <div class="form-inline">
                                    <div class="form-group">
                                        <select class="form-control select-for-delete">
                                            {% for p in pages %}
                                                <option value="{{p.pageid}}" name="{{p.pagename}}">{{p.pagename}}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <button class="btn btn-danger delete-page-button">Delete</button>
                                </div>
                            </td>
                            <td>
                                <div class="form-inline">
                                    <div class="form-group">
                                        <button class="btn btn-info form-control export">Export</button>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div class="form-inline">
                                    <div class="form-group">
                                        <input type="file" class='form-control load-file' />
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div class="form-inline">
                                    <div class="form-group">
                                        <button class="btn btn-info clear">Clear</button>
                                    </div>
                                </div>
                            </td>
                            
                        </tr>
                    </tbody>
                </table>
        </div>

        <div class="page-option-container" style="height:50px;width:100%;position: relative; padding:10px 0px 10px 0px;"></div>
                
        <div id="whole-page-body" style="border:2px solid #eee; position: relative;">
        </div>


        <div class="modal fade bs-example-modal-lg" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
            <div class="modal-dialog page" style="height:80% ; width:80%;">
                <div class="modal-content">
                    <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                    <h4 class="modal-title" id="myModalLabel">New Generate Chart</h4>
                    </div>
                    <div class="modal-body page-modal-body">
                        <div class="modal-main" style="overflow:hidden;padding:15px;">
                            {% include 'chart/window_main.html' %}
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary addchart">Add a chart</button>
                    </div>
                </div>
            </div>
        </div>


        <div class="modal fade bs-example-modal-sm" id="load-sc-history" tabindex="-1" role="dialog" aria-labelledby="load-sc-head" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                        <h4 class="modal-title" id="load-sc-head">Load Chart From Single Chart History Saved</h4>
                    </div>
                    <div class="modal-body">
                        <div>
                            {% set i = 0 %}
                            {% for w in windows %}
                                {% set wn = i / 4 %}
                                {% if i % 4 == 0 %}
                                    <div class="row">
                                {% endif %}
                                <div class="col-sm-3"><label class="radiobox-inline no_indent"><input type="radio" value="{{w.windowid}}" name="window">{{w.windowname}}</div>
                                {% if i % 4 == 3 %}
                                    </div>
                                {% endif %}

                                {% set i = i + 1 %}
                            {% endfor %}
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary confirm-load-sc">Load</button>
                    </div>
                </div>
            </div>
        </div>

                        
        <!-- loading jQuery -->
        <script type="text/javascript" src="{{url_for('static',filename='js/jquery-2.1.1.js')}}"></script>
        <!-- loading jQuery UI javascript -->
        <script type="text/javascript" src="{{url_for('static',filename='js/jquery-ui.min.js')}}"></script>
        <!-- loading Bootstrap javascript (required only when you intend to use option.bootstrap) -->
        <script type="text/javascript" src="{{url_for('static',filename='js/bootstrap.min.js')}}"></script>
        <script type="text/javascript" src="{{url_for('static',filename='js/jquery.jspanel.min.js')}}"></script>

        <script type="text/javascript" src="{{url_for('static',filename='js/highstock.js')}}"></script>
        <script type="text/javascript" src="{{url_for('static',filename='js/chart.js')}}"></script>
        <script type="text/javascript" src="{{url_for('static',filename='js/moment.js')}}"></script>
        <script type="text/javascript" src="{{url_for('static',filename='js/bootstrap-datetimepicker.js')}}"></script>
        <script type="text/javascript" src="{{url_for('static',filename='js/jquery.dataTables.min.js')}}"></script>
        <script type="text/javascript" src="{{url_for('static',filename='js/dataTables.bootstrap.js')}}"></script>
        <script type="text/javascript" src="{{url_for('static',filename='js/window_base.js')}}"></script>


        <script type="text/javascript">
            $(document).ready(function()
            {   
                // default value
                var default_panel_count = 9;
                var default_margin_height = 0;
                var default_margin_width = 2;
                var default_panel_header_height = 29;
                var default_panel_footer_height = 21;
                var default_page_header_height = 50;
                var default_option_height = 51;
                var default_page_content_border = 2;
                var page_content_selector = '#whole-page-body';
                var page_option_panel;
                var whole_page_panel_id_prefix = "jspanel_";

                var current_window_index;
                // var callback;

                
                // class and selector
                var jsPanel_class = 'jsPanel';
                var jsPanel_content_class = 'jsPanel-content';
                var chart_container_class = 'chartinpage';

                var load_single_chart_history_class = 'load_sc';
                var load_single_chart_history_selector = 'button.' + load_single_chart_history_class;

                var load_sc_chart_modal_selector = '#load-sc-history';

                var confirm_load_sc_class = 'confirm-load-sc';
                var confirm_load_sc_selector = 'button.' + confirm_load_sc_class;

                var window_radio_input_selector = 'input[name="window"]';

                var new_generate_chart_class = 'new-generate-chart';
                var new_generate_chart_selector = 'button.' + new_generate_chart_class;

                var setting_icon_class = 'setting-icon';
                var setting_icon_selector = 'i.' + setting_icon_class;

                var refresh_icon_class = 'refresh-icon';
                var refresh_icon_selector = 'i.' + refresh_icon_class;

                var display_chart_modal_selector = '#myModal';

                var add_chart_modal_selector = 'button.addchart';

                var panelheading_selector = 'div.jsPanel-hdr';
                var panelheading_title_selector = '.jsPanel-title';

                var page_option_table_container_selector = 'div.table-container';

                var page_option_container_selector = 'div.page-option-container';

                var load_select_class = 'select-for-load';
                var load_select_selector = 'select.' + load_select_class;

                var delete_select_class = 'select-for-delete';
                var delete_select_selector = 'select.' + delete_select_class;
                var save_button_class = 'saveButton';
                var save_button_selector = 'button.' + save_button_class;
                var saved_name_selector  = '#savetext';

                var delete_class = 'delete-page-button';
                var delete_selector = 'button.' + delete_class;

                var clear_button_class = 'clear';
                var clear_button_selector = 'button.' + clear_button_class;

                var export_button_class = 'export';
                var export_button_selector = 'button.' + export_button_class;

                var load_file_button_class = "load-file";
                var load_file_input_selector = 'input.' + load_file_button_class;

                var modal_content_selector = 'div.modal-main';



                ///////// *** init *** /////////////////
                $(page_content_selector).height($(window).height() - default_page_header_height - 2*default_page_content_border - default_option_height);
                var modal_height = $(window).height()*0.9 - 56 - 65 - 10;
                var modal_width = $(window).width()*0.8 - 30 - 30 ;
                $(modal_content_selector).height(modal_height);
                $(modal_content_selector).width(modal_width);
                // refresh_page(default_panel_count);

                function whole_page()
                {

                    this.whole_page_panel_count = null;
                    // refresh
                    this.config_index_position_map = {};
                    this.config_index_panel_map = {};
                    this.panel_content_height = null;
                    this.panel_content_width = null;

                    this.config_index_chart_index_map = {};
                    this.chart_index_config_index_map = {};

                    this.nine_charts = {};
                    this.callback;

                    this.set_whole_page_panel_count = function(new_count)
                    {
                        this.whole_page_panel_count = new_count;
                    }

                    this.clear_new_page = function()
                    {
                        // this.remove_exist_panel();
                        this.clear_old_config();
                        this.clear_exist_panel();
                        this.get_new_config();
                        this.add_panel_of_count();
                    }

                    this.clear_old_config = function()
                    {
                        for (var index in this.config_index_position_map) {
                            delete this.config_index_position_map[index];
                        }

                        for (var key in this.config_index_chart_index_map) {
                            delete this.config_index_chart_index_map[key];
                        }

                        for (var key in this.chart_index_config_index_map)
                        {
                            delete this.chart_index_config_index_map[key];
                        }

                        this.panel_content_height = null;
                        this.panel_content_width = null;

                        for (var key in this.nine_charts)
                        {
                            this.clear_old_by_index(key);
                        }
                    }

                    this.clear_exist_panel = function()
                    {
                        for (var index in this.config_index_panel_map) {
                            if (this.config_index_panel_map[index] != undefined ) {
                                this.config_index_panel_map[index].close();
                            };
                            delete this.config_index_panel_map[index];
                        };
                    }

                    this.get_new_config = function()
                    {
                        var row_count = Math.round(Math.sqrt(this.whole_page_panel_count));
                        var col_count = Math.ceil(this.whole_page_panel_count/row_count);
                        // console.log(desired_count,row_count,col_count);

                        var total_height = $(window).height() - default_page_header_height - 2*default_page_content_border - default_option_height;
                        var total_width = $(window).width() - 2*default_page_content_border ;

                        var panel_height = parseInt(total_height / row_count);
                        var panel_width = parseInt(total_width / col_count);

                        this.panel_content_height = panel_height - default_panel_header_height - default_margin_height - default_panel_footer_height;
                        this.panel_content_width = panel_width - default_margin_width;

                        for (var i = 0; i < this.whole_page_panel_count; i++) {
                            var position_index_col = i % col_count;
                            var position_index_row = parseInt(i / col_count);
                            // console.log(i,position_index_col,position_index_row);
                            var top_value = position_index_row * panel_height;
                            var left_value = position_index_col * panel_width;

                            this.config_index_position_map[i] = {top:top_value,left:left_value};
                        };
                    }

                    this.add_panel_of_count = function()
                    {

                        var toolbarfooter_arr = [
                            {
                                item:     "<i class='fa fa-cog " + setting_icon_class + "' style='cursor:pointer;'></i>" ,
                                event:    "click",
                                callback: this.setting_icon_click_callback
                            },
                            {
                                item:     "<i class='fa fa-refresh " + refresh_icon_class + "' style='cursor:pointer;margin-left:5px;'>",
                                event:    "click",
                                callback: this.refresh_icon_click_callback
                            }
                        ]

                        for (var i = 0; i < this.whole_page_panel_count; i++) {
                            this.config_index_panel_map[i] = $.jsPanel({
                                controls: {close: 'disable'},
                                selector: page_content_selector,
                                id: whole_page_panel_id_prefix + i,
                                title:    "A Tmp Chart in " + i,
                                position: this.config_index_position_map[i],
                                theme:    "primary",
                                size : {width: this.panel_content_width,height: this.panel_content_height},
                                content : this.content_for_index(i),
                                toolbarFooter: toolbarfooter_arr
                            });
                            
                            $( "#jspanel_" + i ).on( "resizestop", this.panel_resize_callback );
                            this.config_index_panel_map[i].on( "jspanelmaximized", this.panel_resize_callback );
                            this.config_index_panel_map[i].on( "jspanelnormalized", this.panel_resize_callback );
                            this.config_index_chart_index_map[i] = i;
                            this.chart_index_config_index_map[i] = i;
                        }
                    }

                    this.content_for_index = function(index)
                    {
                        var tmp_content = "<div class='" + chart_container_class + " text-center' sortId='" + index + "' style='width:100%;height:100%'><div class='row' style='margin-top:" + (this.panel_content_height - 29)/2 + "px;'><button class='btn btn-default btn-sm " + load_single_chart_history_class + "' sortId='" + index + "'>Import Single Chart Saved</button><button class='btn btn-default btn-sm " + new_generate_chart_class + "' sortId='" + index + "'>New Generate</button></div></div>";
                        return tmp_content;
                    }

                    this.panel_resize_callback = function (event,ui)
                    {
                        var tmp_height = $(this).height() - default_panel_footer_height - default_panel_header_height;
                        var tmp_width = $(this).width();
                        // console.log(tmp_height,tmp_width);
                        var chart_container = $(this).find('div.' + chart_container_class).first();
                        var sortId = chart_container.attr("sortId");
                        chart_container.height(tmp_height);
                        chart_container.width(tmp_width);
                        if (wp.nine_charts[parseInt(sortId)] != undefined) {
                            if (wp.nine_charts[parseInt(sortId)]['chart'] != undefined) {

                                wp.nine_charts[parseInt(sortId)]['chart'].get_chart().setSize(tmp_width,tmp_height,false);
                            };
                        };
                        event.stopPropagation();
                    }

                    this.setting_icon_click_callback = function()
                    {
                        // console.log("setting-icon click");
                        // console.log($(this));
                        var sortId = $(this).closest('div.' + jsPanel_class).find('div.' + chart_container_class).first().attr("sortId");
                        current_window_index = sortId;

                        $(display_chart_modal_selector).modal({
                            keyboard: false
                        });
                        $(display_chart_modal_selector).modal('show');

                        if (wp.nine_charts[current_window_index] != undefined) {
                            f.set_smr_cc(wp.nine_charts[current_window_index]['selected_metric_result'],wp.nine_charts[current_window_index]['chart_config']);
                            // f.update_select_badge_from_outer();
                            // f.render_current_selected_metrics_from_outer();
                        };
                    }

                    this.refresh_icon_click_callback = function()
                    {

                        var sortId = $(this).closest('div.' + jsPanel_class).find('div.' + chart_container_class).first().attr("sortId");

                        wp.clear_old_by_index(sortId);
                        wp.clear_specific_container(sortId);
                        wp.render_container_with_template(sortId);
                        add_message_2_page('refresh specific panel','info');
                    }

                    this.render_container_with_template = function(render_index)
                    {

                        this.config_index_panel_map[this.chart_index_config_index_map[render_index]].content.append(this.content_for_index(render_index));
                    }

                    this.clear_specific_container = function(clear_index)
                    {

                        $('div.' + chart_container_class + '[sortId="' + clear_index + '"]').remove();
                    }

                    this.clear_old_by_index = function(refresh_index)
                    {
                        if (this.nine_charts[refresh_index] != undefined) {
                            if (this.nine_charts[refresh_index]['chart'] != undefined) {
                                this.nine_charts[refresh_index]['chart'].clear_chart();
                            };
                        };
                        
                        delete this.nine_charts[refresh_index];
                    }

                    this.refresh_specific_chart = function(refresh_index,refresh_smr,refresh_cc,refresh_chart_name)
                    {
                        var local_display_chart = new chart();
                        local_display_chart.set_selected_metrics(refresh_smr);
                        local_display_chart.set_chart_config(refresh_cc);
                        local_display_chart.clear_chart();
                        local_display_chart.set_highchart();
                        local_display_chart.set_callback(this.callback);

                        // delete nine_charts[current_window_index];
                        this.clear_old_by_index(refresh_index);

                        this.nine_charts[refresh_index] = {};
                        this.nine_charts[refresh_index]['chart'] = local_display_chart;
                        this.nine_charts[refresh_index]['selected_metric_result'] = refresh_smr;
                        this.nine_charts[refresh_index]['chart_config'] = refresh_cc;
                        // change_specific_chart_name(refresh_index,refresh_chart_name);
                        this.change_title_of_index(refresh_index,refresh_chart_name);

                        // console.log(local_display_chart);
                        local_display_chart.create_chart();
                        add_message_2_page("create chart successfully!",'success');
                    }

                    this.change_title_of_index = function(change_index,new_title)
                    {
                        this.config_index_panel_map[this.chart_index_config_index_map[change_index]].title(new_title);
                        if (this.nine_charts[change_index] != undefined) {
                            this.nine_charts[change_index]['chart_name'] = new_title;
                        };

                    }

                    this.save_whole_page_at_server = function(pagename)
                    {
                        var tmp_nine_charts = {};
                        var saved_nine_charts = this.nine_charts;
                        for(index in saved_nine_charts)
                        {
                            var tmp_selected_metrics = jQuery.extend(true, {}, saved_nine_charts[index]['selected_metric_result']);
                            var tmp_chart_config = jQuery.extend(true, {}, saved_nine_charts[index]['chart_config']);
                            tmp_nine_charts[index] = {};
                            tmp_nine_charts[index]['selected_metric_result'] = tmp_selected_metrics;
                            tmp_nine_charts[index]['chart_config'] = tmp_chart_config;
                            tmp_nine_charts[index]['chart_name'] = saved_nine_charts[index]['chart_name'];
                        }
                        // console.log(saved_nine_charts);

                        var option = {  
                            url: '/chart/save/page',  
                            type: 'POST',  
                            data: JSON.stringify({'pagename':pagename,'nine_charts':tmp_nine_charts}),  
                            dataType: 'json', 
                            contentType : 'application/json', 
                            success: function (data) {
                                
                                if (data.save_result_bool) {
                                    
                                    add_specific_page_record(data.save_result['indexId'],data.save_result['name']);
                                    add_message_2_page('Save charts config at Server Successfully','success');
                                }
                                else
                                {
                                    console.log(data.info);
                                    add_message_2_page(data.info,'danger');
                                }
                                $(saved_name_selector).val('');
                            }  
                        };  
                        $.ajax(option);
                    }

                    this.load_page_saved_at_server = function(indexId)
                    {

                        this.refresh_all_panel_content();
                        $.getJSON('/chart/load/page',{pageid:indexId},function(data)
                        {
                            if (data.load_result_bool) {

                                wp.configuration_2_multiple_charts(data.load_result);
                            }
                            else
                            {
                                add_message_2_page(data.info,'danger');
                            }
                        });
                    }

                    this.configuration_2_multiple_charts = function(config)
                    {
                        // console.log(config);

                        var index_arr = [];
                        for ( var key in config) {
                            index_arr.push(key);
                        };
                        var tmp = 0;
                        wp.callback = $.Callbacks();
                        // console.log("callbacks in page",callback);
                        var foo = function()
                        {
                            if (tmp < index_arr.length) {
                                var index = index_arr[tmp];
                                wp.refresh_specific_chart(index,config[index]['selected_metrics'],config[index]['chart_config'],config[index]['chart_name']);
                                tmp += 1;
                            }
                            else
                            {
                                wp.callback.empty();
                                add_message_2_page('load multiple charts successfully!','success');
                            }
                        }
                        wp.callback.add( foo );
                        wp.callback.fire();
                    }

                    this.refresh_all_panel_content = function()
                    {
                        for (var key in this.nine_charts)
                        {
                            wp.clear_old_by_index(key);
                            wp.clear_specific_container(key);
                            wp.render_container_with_template(key);
                        }

                        for (var i = 0; i < this.whole_page_panel_count; i++) {
                            this.change_title_of_index(i,'A Tmp Chart in ' + i);
                        };
                        
                    }

                    this.close_by_chart_index = function(close_index)
                    {
                        var new_whole_page_panel_count = this.whole_page_panel_count - 1 ;
                        var close_panel = this.config_index_panel_map[this.chart_index_config_index_map[close_index]] ;
                        for (var i = this.chart_index_config_index_map[close_index] ; i < this.whole_page_panel_count -1; i++) {
                            this.config_index_panel_map[i] = this.config_index_panel_map[ i + 1 ];
                            this.config_index_chart_index_map[i] = this.config_index_chart_index_map[ i + 1];
                            this.chart_index_config_index_map[this.config_index_chart_index_map[ i + 1]] = i;
                        };
                        delete this.config_index_chart_index_map[this.whole_page_panel_count -1];
                        delete this.config_index_position_map[this.whole_page_panel_count -1];
                        delete this.chart_index_config_index_map[close_index];

                        this.clear_old_by_index(close_index);
                        this.whole_page_panel_count = new_whole_page_panel_count;

                        this.get_new_config();
                        this.update_panel_position();
                    }

                    this.update_panel_position = function()
                    {
                        for (var i = 0; i < this.whole_page_panel_count; i++) {
                            this.config_index_panel_map[i].reposition(this.config_index_position_map[i]);
                            // console.log(this.config_index_panel_map[i]);
                            // console.log(this.config_index_panel_map[i].calcPanelposition());
                            // console.log(this.config_index_position_map[i]);
                            var current_id = whole_page_panel_id_prefix + this.config_index_chart_index_map[i];
                            $("#" + current_id).css({  "top": this.config_index_position_map[i].top + "px", "left": this.config_index_position_map[i].left + "px" });
                            this.config_index_panel_map[i].resize(this.panel_content_width + 'px',(this.panel_content_height + default_panel_header_height + default_margin_height + default_panel_footer_height) + 'px');

                        };
                    }

                }

                $(window).resize(function(e)
                {
                    if (e.target == window) {
                        modal_height = $(window).height()*0.9 - 56 - 65;
                        modal_width = $(window).width()*0.8 - 30 - 30 ;
                        $(modal_content_selector).height(modal_height);
                        $(modal_content_selector).width(modal_width);
                        console.log("resize",modal_height);
                        f.resize_caller(modal_height);
                    };
                });

                // $("body").on( "jspanelclosed", function closeHandler(event, id) {

                //     var tmp_arr = id.split('_');
                //     if (tmp_arr.length >= 2) {
                //         var chart_index = parseInt(tmp_arr[1]);
                //         wp.close_by_chart_index(chart_index);
                //     };
                //     // var chart_index = parseInt(id.split('_')[1]);

                //     // if () {
                //     // };
                    
                // });



                


                function add_specific_page_record(indexId,name)
                {
                    var result_str = '';
                    result_str += '<option value="' + indexId + '" name="' + name + '">' + name + '</option>';

                    $(load_select_selector).append(result_str);
                    $(delete_select_selector).append(result_str);
                }


                function set_auto_complete_in_dashboard()
                {
                    // var new_arr = $.merge( itemtypetags, aws_itemtypetags);
                    var db_search_input_selector = "input.dashboard-search";
                    $(db_search_input_selector).autocomplete({
                        source: itemtypetags,
                        appendTo: "#myModal"
                    });
                }

                function set_auto_complete_in_main()
                {
                    var main_search_input_selector = "input.main-search";
                    $(main_search_input_selector).autocomplete({
                        source: itemtypetags,
                        appendTo: "#myModal"
                    });
                }

                function set_auto_complete_in_billing()
                {
                    var billing_search_input_selector = 'input.billing-search';
                    $(billing_search_input_selector).autocomplete({
                        source: aws_itemtypetags,
                        appendTo: "#myModal"
                    });
                }

                var wp = new whole_page();
                wp.set_whole_page_panel_count(default_panel_count);
                wp.clear_new_page();

                var itemtypetags = {{ itemtypenames|safe }};
                var aws_itemtypetags = {{ aws_itemtypenames|safe }};
                set_auto_complete_in_dashboard();
                set_auto_complete_in_main();
                set_auto_complete_in_billing();

                var f = new window_base(($(window).height() - $('div.navbar-static-top').height() + 25)* 0.8);


                $(document).on('click',load_single_chart_history_selector,function()
                {
                    // console.log("click");
                    current_window_index = $(this).attr("sortId");
                    $(load_sc_chart_modal_selector).modal({
                        keyboard: false
                    });
                    $(load_sc_chart_modal_selector).modal('show');
                });

                $(document).on('click',confirm_load_sc_selector,function()
                {
                    // console.log($('input[name=window]').val());
                    var selected_windowid;
                    var selected_windowname;
                    $(window_radio_input_selector).each(function(i,d)
                    {
                        if (d.checked) {
                            selected_windowid = $(this).attr("value");
                            selected_windowname = $(this).closest('label').text();
                        };
                    });
                    if (selected_windowid == undefined) {
                        alert("you should select single chart before load");
                    }
                    else
                    {
                        $(load_sc_chart_modal_selector).modal('hide');
                        load_window_chart(selected_windowid,current_window_index,selected_windowname); 
                    }
                    
                });

                $(document).on('click',new_generate_chart_selector,function()
                {
                    // console.log("add_chart_page_selector");
                    current_window_index = $(this).attr("sortId");
                    f.set_smr_cc({},{});
                    f.set_default_cc_caller();

                    $(display_chart_modal_selector).modal({
                        keyboard: false
                    });
                    $(display_chart_modal_selector).modal('show');
                });

                $(document).on('click',add_chart_modal_selector,function()
                {

                    // console.log("add_chart_modal_selector");
                    $(display_chart_modal_selector).modal('hide');
                    var selected_metric_result;
                    var chart_config;

                    selected_metric_result = jQuery.extend(true, {}, f.get_selected_metric_result());
                    chart_config = jQuery.extend(true, {}, f.get_chart_config());

                    chart_config['container_class'] = chart_container_class;
                    chart_config['container_selector'] = 'div.' + chart_container_class + '[sortId="' + current_window_index + '"]';
                    var tmp_chart_name = 'new generate chart in : ' + current_window_index;

                    wp.refresh_specific_chart(current_window_index,selected_metric_result,chart_config,tmp_chart_name);
                    add_message_2_page('New generate chart successfully','success');
                });

                $(document).on('click',panelheading_title_selector,function()
                {
                    if( $(this).closest(page_option_container_selector).length <= 0)
                    {
                        console.log("header click");
                        var sortId = $(this).closest('div.' + jsPanel_class).find('div.' + chart_container_class).first().attr("sortId");
                        current_window_index = parseInt(sortId);
                        // console.log(sortId);
                        if ($(this).find('input').length <= 0 ) {
                            var current_text = $(this).text();
                            console.log(current_text);
                            $(this).empty();
                            // tmp_title.addClass("hidden");
                            wp.change_title_of_index(parseInt(sortId),null);
                            $(this).prepend('<input type="text" value="' + current_text + '" class="panel-heading-input" style="color:black" />');
                            $('input.panel-heading-input').focus();
                            $('input.panel-heading-input').select();
                        };
                    }
                    else
                    {
                        if (page_option_panel != undefined) {
                            page_option_panel.smallify();
                        };
                    }
                    
                });

                $(document).on('keypress','input.panel-heading-input',function(event)
                {
                    if ( event.which == 13) {
                        $(this).addClass("hidden");
                        // $(this).
                    }
                });

                $(document).on('focusout','input.panel-heading-input',function()
                {
                    console.log("focusout");

                    var current_window_name;
                    if ($(this).val() != '') {
                        current_window_name = $(this).val()
                    }
                    else
                    {
                        current_window_name = 'tmp chart ' + current_window_index;
                    }
                    $(this).remove();


                    wp.change_title_of_index(current_window_index,current_window_name);
                    // wp.change_specific_chart_name(current_window_index,current_window_name);
                });

                $(display_chart_modal_selector).on('shown.bs.modal', function () {

                    if (f.get_display_chart() != undefined) {
                        f.update_call();
                    };

                });

                $(display_chart_modal_selector).on('hidden.bs.modal',function()
                {
                    if (f.get_display_chart() != undefined) {
                        f.get_display_chart().clear_chart();
                    };
                });

                function load_window_chart(windowid,render_index,selected_windowname)
                {
                    $.getJSON('/chart/load/window',{windowid:windowid,render_index:render_index,selected_windowname:selected_windowname},function(data)
                    {
                        // console.log(data);
                        if (data.load_result_bool && data.index != undefined) {
                            var tmp_selected_metric_result = {};
                            tmp_selected_metric_result = data.load_result['selected_metrics'];
                            var tmp_chart_config = {};
                            tmp_chart_config = data.load_result['chart_config'];
                            // console.log(tmp_chart_config);
                            var index = parseInt(data.index);
                            tmp_chart_config['container_class'] = chart_container_class;
                            tmp_chart_config['container_selector'] = 'div.' + chart_container_class + '[sortId="' + index + '"]';
                            var chart_name = data.selected_windowname;
                            if (chart_name == undefined) {
                                chart_name = 'tmp chart ' + index;
                            }
                            else
                            {
                                chart_name = 'Import from saved chart : ' + chart_name;
                            }
                            console.log(data);
                            wp.refresh_specific_chart(index,tmp_selected_metric_result,tmp_chart_config,chart_name);
                        }
                        else
                        {
                            if (data.index != undefined) {
                                add_message_2_page(data.info,'danger');
                            }
                            else
                            {
                                add_message_2_page('Have no index','danger');
                            }
                        }
                    });
                }

                function add_message_2_page(message,type)
                {
                    // console.log(message,type);
                    // var message_panel = $.jsPanel({
                    //     paneltype: 'hint',
                    //     theme:     type,
                    //     position:  {top : default_page_header_height, left: 'center'},
                    //     size:      { width: 400, height: 'auto' },
                    //     content:   "<div style='...'>" + message + "</div>"
                    // });
                    // console.log(message_panel);
                    var content_str;
                    var autoclose_value = 2000;
                    switch(type)
                    {
                        case 'success':
                            content_str = '<div style="font-size:26px;"><div style="float:left;width:auto;height:100%"><span class="glyphicon glyphicon-ok-sign" style="font-size:30px;padding:20px;"></span></div><p style="padding:26px 0;">' + message + '</p></div>';
                            break;

                        case 'danger':
                            content_str = '<div style="font-size:26px;"><div style="float:left;width:auto;height:100%"><span class="glyphicon glyphicon-warning-sign" style="font-size:30px;padding:20px;"></span></div><p style="padding:26px 0;">' + message + '</p></div>';
                            autoclose_value = -1;
                            break;

                        case 'info':
                            content_str = '<div style="font-size:26px;"><div style="float:left;width:auto;height:100%"><span class="glyphicon glyphicon-info-sign" style="font-size:30px;padding:20px;"></span></div><p style="padding:26px 0;">' + message + '</p></div>';
                            break;

                        default:
                            content_str = 'unknown message';
                            break;
                    }

                    var message_panel = $.jsPanel({
                        paneltype: 'hint',
                        theme:     type,
                        autoclose: autoclose_value,
                        position:  {top : default_page_header_height, left: 'center'},
                        size:      { width: 400, height: 'auto' },
                        content:   content_str
                    });
                }

                load_page_option_panel();

                function load_page_option_panel()
                {
                    var html_str = $(page_option_table_container_selector).html();
                    var option_panel_width = $(page_option_container_selector).width();
                    // console.log(html_str);
                    page_option_panel = $.jsPanel({
                        draggable: "disabled",
                        resizable: "disabled",
                        controls: {
                            minimize: 'disable',
                            maximize: 'disable',
                            close: 'disable',
                            normalize: 'disable'
                        },
                        title: 'Whole Page Options',
                        selector: page_option_container_selector,
                        theme:     'info',
                        position:  {top : '0px', left: '0px'},
                        size: {width:option_panel_width,height:'auto'},
                        content:   html_str
                    });
                    $(page_option_table_container_selector).remove();
                    page_option_panel.smallify();
                }

                $(document).on('click',save_button_selector,function()
                {
                    var pagename = $(saved_name_selector).val();
                    if (pagename != undefined && pagename != null && pagename != '') {
                        wp.save_whole_page_at_server(pagename);
                    }
                    else
                    {
                        add_message_2_page('saved name cannot be empty','danger');
                    }
                });

                $(document).on('change',load_select_selector,function()
                {
                    var indexId = $(this).val();
                    if (indexId != "-1") {
                        // console.log(indexId);
                        wp.load_page_saved_at_server(indexId);
                    }
                    else
                    {
                        clear_all_refresh_title();
                    }
                });

                function rm_specific_page_record(tmp_indexId)
                {
                    $('option[value="' + tmp_indexId + '"]').remove();
                }

                function delete_page_config_in_server(tmp_indexId)
                {
                    // console.log(tmp_indexId);
                    $.getJSON('/chart/delete/page',{pageid:tmp_indexId},function(data)
                    {
                        if (data.delete_result_bool) {
                            // console.log(data.delete_result);
                            // $('button[indexId="' + data.delete_result + '"]' ).remove();
                            rm_specific_page_record(data.delete_result);
                            add_message_2_page('delete specific config successfully','success');
                        }
                        else
                        {
                            add_message_2_page(data.info,'danger');
                        }
                    });
                }

                $(document).on('click',delete_selector,function()
                {
                    // var pagename = 
                    var indexId = $(delete_select_selector).val();
                    var pagename = $('option[value="' + indexId + '"]').attr("name");
                    // if (confirm(' Are you sure to delete page: ' + pagename)) {
                    //     delete_page_config(indexId);
                    // }
                    var arr = [
                        {
                            item:     '<button type="button" class="btn btn-danger btn-sm"><span class="glyphicon glyphicon-remove"></span></button>',
                            event:    "click",
                            btnclass: "btn-sm",
                            btntext:  " Close",
                            callback: function( event ){ event.data.close() }
                        },
                        {
                            item:     '<button type="button" class="btn btn-primary btn-sm"><span class="glyphicon glyphicon-ok"></span></button>',
                            event:    "click",
                            btnclass: "btn-sm",
                            btntext:  " Ok",
                            callback:  function( event ){ 
                                event.data.close(); 
                                delete_page_config_in_server(indexId);
                            }
                        }
                    ];
                    $.jsPanel({
                        paneltype: {
                            type: 'modal',
                            mode: 'default'
                        },
                        id: 'confirm_modal',
                        title: 'Notification',
                        theme:    'medium',
                        toolbarFooter: arr,
                        content: '<div style="font-size:26px;"><div style="float:left;width:auto;height:100%"><span class="glyphicon glyphicon-info-sign" style="font-size:30px;padding:20px;"></div><p style="padding:26px 0;">Are you sure to delete page with name : <b>' + pagename + '</b></p></div>'

                    });
                });

                $(document).on('click',clear_button_selector,function()
                {
                    wp.refresh_all_panel_content();
                    add_message_2_page('Refresh Multiple charts successfully','success');
                    $(load_select_selector).val(-1);
                });

                $(document).on('click',export_button_selector,function()
                {

                    var tmp_nine_charts = {};
                    saved_nine_charts = wp.nine_charts;
                    for(index in saved_nine_charts)
                    {
                        var tmp_selected_metrics = jQuery.extend(true, {}, saved_nine_charts[index]['selected_metric_result']);
                        var tmp_chart_config = jQuery.extend(true, {}, saved_nine_charts[index]['chart_config']);
                        tmp_nine_charts[index] = {};
                        tmp_nine_charts[index]['selected_metric_result'] = tmp_selected_metrics;
                        tmp_nine_charts[index]['chart_config'] = tmp_chart_config;
                        tmp_nine_charts[index]['chart_name'] = saved_nine_charts[index]['chart_name'];
                    }


                    var data = JSON.stringify(tmp_nine_charts);
                    var csvContent = "data:text/json;charset=utf-8,";
                    csvContent += data;

                    var encodedUri = encodeURI(csvContent);
                    var link = document.createElement("a");
                    link.setAttribute("href", encodedUri);
                    link.setAttribute("download", "monitor_nine_charts_data.json");
                    link.setAttribute("for", "export");

                    link.click(); 
                    $('a[for=export]').remove();
                });

                $(document).on('change',load_file_input_selector,function(event)
                {
                    // var file = e.target.files[0];
                    // console.log(file);
                    readSingleFile(event);
                });

                function convert_from_json(contents)
                {
                    try
                    {
                        var tmp_json = JSON.parse(contents);
                        return tmp_json;
                    }
                    catch(err)
                    {
                        wp.refresh_all_panel_content();
                        add_message_2_page('input file is not a monitor json template file','danger');
                    }
                    // console.log(tmp_json);
                }

                function readSingleFile(e) {
                    var file = e.target.files[0];
                    if (!file) {
                        return;
                    }
                    var reader = new FileReader();
                    reader.onload = function(e) {
                        var contents = e.target.result;
                        var saved_nine_charts = convert_from_json(contents);
                        try
                        {
                            var tmp_nine_charts = {};

                            for(index in saved_nine_charts)
                            {
                                var tmp_selected_metrics = jQuery.extend(true, {}, saved_nine_charts[index]['selected_metric_result']);
                                var tmp_chart_config = jQuery.extend(true, {}, saved_nine_charts[index]['chart_config']);
                                tmp_nine_charts[index] = {};
                                tmp_nine_charts[index]['selected_metrics'] = tmp_selected_metrics;
                                tmp_nine_charts[index]['chart_config'] = tmp_chart_config;
                                tmp_nine_charts[index]['chart_name'] = saved_nine_charts[index]['chart_name'];
                            }

                            wp.refresh_all_panel_content();
                            wp.configuration_2_multiple_charts(tmp_nine_charts);
                        }
                        catch(err)
                        {
                            add_message_2_page('load charts from local file error','danger');
                            wp.refresh_all_panel_content();
                        }
                        
                    };
                    try
                    {
                        reader.readAsText(file);
                    }
                    catch(err)
                    {
                        add_message_2_page('read file error','danger');
                        wp.refresh_all_panel_content();
                    }
                    
                }
                
            });
        </script>

    </body>
</html>